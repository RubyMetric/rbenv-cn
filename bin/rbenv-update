#!/usr/bin/env bash
#
# Summary: 更新三部分
#
# Usage: rbenv update
#
# 将更新3个部分
#   1. 从gitee.com/RubyKis镜像更新 rbenv
#   2. 从Gitee mirror官方镜像更新 ruby-build
#   3. 更新包含 `rbenv-cn` 在内的所有插件(位于 ~/.rbenv/plugins)
#
# 显示本帮助:
#   rbenv help update
#   rbenv update --help   
#

# ------------------------------------------------------
# File          : rbenv-update.sh
# Authors       : ccmywish <ccmywish@qq.com>
#                 Konstantin Haase <github@rkh.im>
# Created on    : <2020-12-09>
# Last modified : <2022-04-09>
#
# rbenv-update:
#
#   See summary and usage above
# ------------------------------------------------------

# Set colored output for TTY
if [ -t 1 ]; then
  color="\e[1;32m"
  reset="\e[0m"
else
  color=""
  reset=""
fi

echo_colored() {
  printf "${color}%s${reset}\n" "$1"
}


is_git_repo() {
  command git remote -v 2>/dev/null 
}

plugin_update() {
  if is_git_repo; then
    echo_colored "rbenv-cn> 更新 $1 ..."
    git pull --no-rebase --ff
    echo
  else
    echo_colored "rbenv-cn> 跳过 $1; 不是一个Git仓库"
  fi
}

echo_colored "rbenv-cn> 从gitee.com/RubyKids镜像更新rbenv"
git -C $RBENV_ROOT pull 

echo

# If no match, just remove the word, rather than see it as a file called *
shopt -s nullglob
for plugin in "$RBENV_ROOT"/plugins/*; do
  pushd "$plugin" >/dev/null
  plugin_update "$(basename "$plugin")"
  popd >/dev/null
done
shopt -u nullglob

echo_colored "rbenv-cn> rbenv 以及所有插件更新完成!"
